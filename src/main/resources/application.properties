# ===================================================================
# NOME DA APLICAÇÃO E PORTA DO SERVIDOR
# ===================================================================
spring.application.name=gastro-reserva
server.port=8080


# ===================================================================
# CONFIGURAÇÃO DO BANCO DE DADOS - MICROSOFT SQL SERVER (NOVA)
# ===================================================================
# URL de conexão completa para o seu servidor SQL Server.
spring.datasource.url=jdbc:sqlserver://AN0101705085940\SQLEXPRESS2024;databaseName=bdGastroReserva;encrypt=false

# Credenciais do usuário dedicado que criamos no SQL Server.
spring.datasource.username=gastro_user
spring.datasource.password=gastroreserva123

# Dialeto específico para o Hibernate se comunicar corretamente com o SQL Server.
spring.jpa.database-platform=org.hibernate.dialect.SQLServerDialect

# ESSENCIAL COM FLYWAY: O Hibernate irá validar se as entidades correspondem às tabelas.
# Ele não irá criar nem alterar nada, deixando esse trabalho para o Flyway.
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.generate-ddl=false


# ===================================================================
# CONFIGURAÇÃO DO FLYWAY (Versionador do Banco)
# ===================================================================
# O Flyway usará automaticamente as configurações 'spring.datasource' acima,
# então não precisamos mais das URLs específicas para ele.
spring.flyway.locations=classpath:db/migration
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
# A linha 'spring.flyway.schemas=PUBLIC' foi removida pois 'PUBLIC' é do H2.
# O Flyway usará o schema padrão do usuário 'gastro_user' no SQL Server (geralmente 'dbo').


# ===================================================================
# CONFIGURAÇÕES ANTIGAS DO H2 (COMENTADAS PARA REFERÊNCIA)
# ===================================================================
#spring.datasource.url=jdbc:h2:mem:gastroDB
#spring.datasource.driverClassName=org.h2.Driver
#spring.datasource.username=sa
#spring.datasource.password=
#spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
#spring.h2.console.path=/h2-console
#spring.h2.console.enabled=true
#spring.flyway.url=jdbc:h2:mem:gastroDB
#spring.flyway.user=sa
#spring.flyway.password=


# ===================================================================
# CONFIGURAÇÕES GERAIS E DE DEBUG (MANTIDAS)
# ===================================================================
# Mostra o SQL gerado pelo Hibernate no console.
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# Níveis de log para depuração.
logging.level.org.springframework=DEBUG
logging.level.org.springframework.security=DEBUG

# Não incluir o stacktrace completo em respostas de erro HTTP.
server.error.include-stacktrace=never


# ===================================================================
# CONFIGURAÇÃO DE ENVIO DE EMAIL (MANTIDA)
# ===================================================================
spring.mail.host=smtp.gmail.com
spring.mail.port=587
spring.mail.username=gastroreserva.ceub@gmail.com
spring.mail.password=owqz ryrg qrpg kqqa
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true

# ===================================================================
# CONFIGURAÇÃO DO BANCO DE DADOS SQL SERVER
# ================================================================

IF NOT EXISTS (SELECT * FROM sys.server_principals WHERE name = 'gastro_user')
BEGIN
-- !! MUITO IMPORTANTE: Substitua 'sua_senha_muito_forte_aqui' por uma senha segura de sua escolha !!
CREATE LOGIN gastro_user WITH PASSWORD = 'gastroreserva123';
PRINT 'Login "gastro_user" criado com sucesso.';
END
ELSE
BEGIN
PRINT 'Login "gastro_user" já existe.';
END
GO


-- PASSO 2: Dar permissão a esse Login para usar o banco de dados que você criou.
-- Primeiro, garantimos que estamos no contexto do banco de dados correto.
USE bdGastroReserva;
GO

-- Agora, criamos um "Usuário" dentro do banco de dados e o ligamos ao Login.
IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = 'gastro_user')
BEGIN
CREATE USER gastro_user FOR LOGIN gastro_user;
PRINT 'Usuário "gastro_user" criado dentro do banco "bdGastroReserva".';

-- Finalmente, damos ao usuário permissão total DENTRO DESTE BANCO DE DADOS.
-- Isso é necessário para que o Flyway possa criar e gerenciar as tabelas.
ALTER ROLE db_owner ADD MEMBER gastro_user;
PRINT 'Permissões de Dono do Banco de Dados concedidas ao usuário "gastro_user".';
END
ELSE
BEGIN
PRINT 'Usuário "gastro_user" já existe no banco "bdGastroReserva".';
END
GO

PRINT 'Configuração de segurança concluída!';